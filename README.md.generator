#!/bin/bash



# README.md.generator - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ README.md –≤ —Ç–µ–∫—É—â–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ.
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥ —Ä–µ–ø–æ–∑–∏—Ç–∞—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–º, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç.
# –í–Ω–∏–º–∞–Ω–∏–µ! –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω –∏—Å–∫—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–∞—Ä–∏—è!



# *************************************************************************************************************************************************************
# * –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è)
# *************************************************************************************************************************************************************



# *************************************************************************************************************************************************************
# * –§—É–Ω–∫—Ü–∏–∏ –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–µ)
# *************************************************************************************************************************************************************

# -----------------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è press_any_key_to_continue
# –∂–¥—ë—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–∂–∞—Ç–∏—è –ª—é–±–æ–π –∫–ª–∞–≤–∏—à–∏
#
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –Ω–µ—Ç
# -----------------------------------------------------------------------------
function press_any_key_to_continue {
	
	echo "Press any key to continue..."

	# -s: Do not echo input coming from a terminal
	# -n 1: Read one character
	read -s -n 1
	echo -en "\n"

	return 0
} # press_any_key_to_continue

# -----------------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è spinner
# –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤—ã–≤–æ–¥–∏—Ç –≤—Ä–∞—â–∞—é—â—É—é—Å—è –ø–∞–ª–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω
#
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ: –Ω–µ—Ç
# -----------------------------------------------------------------------------
function spinner {
	local i=1
	local -r symbols="/-\|"
	echo -n ' '
	while [[ true ]]; do
		printf "\b${symbols:i++%${#symbols}:1}"
		sleep .1
	done
} # spinner



# *************************************************************************************************************************************************************
# * –§—É–Ω–∫—Ü–∏–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–¥–∞—á —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
# *************************************************************************************************************************************************************

# -----------------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è readme_generator
# –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤ —Ç–µ–∫—É—â–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ ($PWD) README.md –≤ stdout
#
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –Ω–µ—Ç
# -----------------------------------------------------------------------------
function readme_generator {

    local i

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–¥–µ–ª –û–ø–∏—Å–∞–Ω–∏–µ
    echo "# –û–ø–∏—Å–∞–Ω–∏–µ"
    echo ""
    for i in $(git ls-files sources/*.bash); do
        sed -nE '2 s/^(abs.*\.bash)(\ -\ .*)$/**\1**\2<br\/>\n/p' <(./"$i" --help)
    done
    echo ""

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–¥–µ–ª –£—Å—Ç–∞–Ω–æ–≤–∫–∞
    cat <<EOF
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞

0. **sources/*.bash** —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –æ–¥–Ω–æ–º –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π \$PATH<br/>
0. **sources/*-completion** - —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ bash - —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ /etc/bash_completion.d/ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Fedora 40)<br/>
0. –í–∑—è–≤ –∑–∞ –æ—Å–Ω–æ–≤—É **sources/.absmsg-credentials.EXAMPLE**, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ absmsg.bash. –î–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ –∏ –°–ú–°. –ë–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ --credentials —Å–∫—Ä–∏–ø—Ç absmsg.bash –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ñ–∞–π–ª—É ~/.absmsg-credentials –ù—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —ç—Ç–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ—Ç sudo: –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –¥–æ–º–∞—à–Ω–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ root, –∏–ª–∏ —É–∫–∞–∑–∞—Ç—å –≤–æ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç absmsg.bash, –¥—Ä—É–≥–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.
EOF

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–¥–µ–ª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    echo "# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ"
    echo ""
    for i in $(git ls-files sources/*.bash); do
        echo "## $i"
        echo '```'
        tail -n +6 <(./"$i" --help)
        echo -e '```\n'
    done
    echo ""

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å–Ω—É—é –ª–∏–Ω–∏—é
    cat <<EOF
---
¬© Sergey Vasiliev, 2024<br/>
- <a href="mailto:vasiliev.s@komdiv.org" target="_blank">vasiliev.s@komdiv.org</a><br/>
- <a href="mailto:abs.tambov@gmail.com" target="_blank">abs.tambov@gmail.com</a><br/>
EOF

	return 0
} # readme_generator

# -----------------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è main
# –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞
#
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –Ω–µ—Ç
# -----------------------------------------------------------------------------
function main {

	local spinner_pid		# –°–æ–¥–µ—Ä–∂–∏—Ç pid –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–π –≤ —Ñ–æ–Ω–µ —Ñ—É–Ω–∫—Ü–∏–∏

	# -----------------------------------------------------------------------------
	# –§—É–Ω–∫—Ü–∏—è ctrl_c
	# –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Ctrl+C
	#
	# –ê—Ä–≥—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç
	# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –Ω–µ—Ç
	# -----------------------------------------------------------------------------
	function ctrl_c {
		
		# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ —á–∏—Å—Ç–∏–º —ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –Ω–µ–≥–æ –∏ press_any_key_to_continue
		kill $spinner_pid && wait $spinner_pid 2>/dev/null
		tput cr 	# carriage_return (cr/) cr  carriage return (P*) (P*)
		tput cuu1	# cursor_up (cuu1/up)  up one line
		tput el		# clr_eol (el/ce) clear to end of line (P)

		echo ""
		echo "–û—Ç–º–µ–Ω–µ–Ω–æ."

		exit 0
	} # ctrl_c

	# -----------------------------------------------------------------------------

	if [[ -w README.md ]]; then
		echo -n "README.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ${PWD} –∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∞–Ω! "
	else
		echo -n "–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π README.md –≤ ${PWD}. "
	fi
	echo "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–º–µ–Ω—ã."

	# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
	spinner &
	spinner_pid=$!

	# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Ctrl+C (—Å–∏–≥–Ω–∞–ª SIGINT)
	trap ctrl_c SIGINT

	# ...
	press_any_key_to_continue
	readme_generator >README.md

	# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ —á–∏—Å—Ç–∏–º —ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –Ω–µ–≥–æ –∏ press_any_key_to_continue
	kill $spinner_pid && wait $spinner_pid 2>/dev/null
	tput cr 	# carriage_return (cr/) cr  carriage return (P*) (P*)
	tput cuu1	# cursor_up (cuu1/up)  up one line
	tput cuu1	# cursor_up (cuu1/up)  up one line
	tput el		# clr_eol (el/ce) clear to end of line (P)

	echo ""
	echo "–ì–æ—Ç–æ–≤–æ."

    return 0
} # main



# *************************************************************************************************************************************************************
# * –°–∞–º —Å–∫—Ä–∏–ø—Ç üòä
# *************************************************************************************************************************************************************

main "$@"
exit $?

# *************************************************************************************************************************************************************
